#!/usr/bin/env node

'use strict';

var beautify = require('js-beautify').js_beautify,
    fs = require('fs'),
    argv = require('minimist')(process.argv.slice(2));

var data = JSON.parse(fs.readFileSync(argv._[0]));


var migrated = false;

if (data.version === 2) {
    // Migrate to v3
    data = require('../migrations/v3')(data);
    migrated = true;
}

if (data.version === 3) {
    // Migrate to v4
    data = require('../migrations/v4')(data);
    data = require('../migrations/v4-bonus')(data);
    migrated = true;
}

if (data.version === 4 || data.version === 5) {
    // Migrate to v5
    data = require('../migrations/v5')(data);
    migrated = true;
}

if (!migrated) {
    console.warn('cannot migrate from', data.version);
    process.exit(1);
}

function format(json) {
    var str = beautify(JSON.stringify(json), {
        indent_size: 2,
        keep_array_indentation: true
    }).replace(/"filter": {[^}]+}/g, function (str) {
        var str2 = str.replace(/([{}])\s+/g, '$1 ').replace(/,\s+/g, ', ').replace(/\s+}/g, ' }');
        return str2.length < 100 ? str2 : str;
    });
    return str;
}

console.log(format(data));
